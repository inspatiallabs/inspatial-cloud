import convertString from "../../../utils/convert-string.ts";
import type { EntryType } from "../../entry/entry-type.ts";
import { SettingsType } from "../../settings/settings-type.ts";
import { buildFields } from "./build-fields.ts";

export function generateClientEntryTypes(entryTypes: Array<EntryType>) {
  const generatedEntries: string[] = [];
  const entryTypeNames = new Map<string, string>();
  for (const entryType of entryTypes) {
    entryTypeNames.set(
      entryType.name,
      convertString(entryType.name, "pascal", true),
    );
    const entryInterface = generateClientEntryInterface(entryType);
    entryInterface && generatedEntries.push(entryInterface);
  }
  const outLines: string[] = [
    ...generatedEntries,
    "declare global {",
    "  export interface EntryMap {",
    ...Array.from(entryTypeNames.entries()).map(
      ([name, className]) => `    ${name}: ${className}`,
    ),
    "  }",
    "",
    "  export type EntryName = keyof EntryMap;",
    "  export type Entry<E extends EntryName = EntryName> = EntryMap[E];",
    "}",
  ];
  return [
    "// This file is generated by the InSpatial Cloud Backend.",
    "// Do not edit this file directly.",
    "",
    ...outLines,
  ].join("\n");
}

export function generateClientSettingsTypes(
  settingsTypes: Array<SettingsType>,
) {
  const generatedSettings: string[] = [];
  const settingsTypeNames = new Map<string, string>();
  for (const settingsType of settingsTypes) {
    settingsTypeNames.set(
      settingsType.name,
      convertString(settingsType.name, "pascal", true),
    );
    const settingsInterface = generateClientEntryInterface(settingsType);
    settingsInterface && generatedSettings.push(settingsInterface);
  }
  const outLines: string[] = [
    ...generatedSettings,
    "declare global {",
    "  export interface SettingsMap {",
    ...Array.from(settingsTypeNames.entries()).map(
      ([name, className]) => `    ${name}: ${className}`,
    ),
    "  }",
    "",
    "  export type SettingsName = keyof SettingsMap;",
    "  export type Settings<S extends SettingsName = SettingsName> = SettingsMap[S];",
    "}",
  ];
  return [
    "// This file is generated by the InSpatial Cloud Backend.",
    "// Do not edit this file directly.",
    "",
    ...outLines,
  ].join("\n");
}
export function generateClientEntryInterface(
  entryOrSettingsType: EntryType | SettingsType,
): string | undefined {
  // if (!entryType.dir) {
  //   return;
  // }
  const className = convertString(entryOrSettingsType.name, "pascal", true);
  const outLines: string[] = [
    `export interface ${className} {`,
    ` _name:"${convertString(entryOrSettingsType.name, "camel", true)}"`,
  ];

  const fields = buildFields(entryOrSettingsType.fields);
  outLines.push(...fields);
  for (const child of entryOrSettingsType.children?.values() || []) {
    const childFields = buildFields(child.fields);
    outLines.push(
      `${child.name}: Array<{ ${childFields.join("\n")}}>`,
    );
  }
  outLines.push("}");
  return outLines.join("\n");
}
